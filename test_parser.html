 <!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8"/>
  <title>test-parser</title>

  <script src="jquery-2.2.0.js"></script>

  <link href="mocha.css" rel="stylesheet" />.
  <script src="deepDiff.js"></script>
  <script src="mocha.js"></script>
  <script src="chai.js"></script>
  <script>
	//mocha.checkLeaks();
    //mocha.globals(['jQuery']);
    mocha.setup('bdd');
    var assert = chai.assert;
  </script>

  <script src="utils.js"></script>
  <script src="modules_manager.js"></script>
  <script src="parser.js"> </script>

  </head>
<body>
	<div id="mocha"/>
<script>
;(function(){
	'use strict';
	copyProps(require('parser'),window);
	function assertDeepEqual(real,expected) {
		try{
			assert.deepEqual(expected,real);
		}
		catch(err){
			//console.log(err)
			err.message+='\nexpected: '+JSON.stringify(expected,'',4)+'\nreal: '+JSON.stringify(real,'',4);
			//console.log(err)
			throw err
		}
		/*
		var diff = DeepDiff(expected,real);
		if(diff.length!==0) {
			//console.log(diff);
		}*/
	}
	function it_sf(str,fun,code) {
		function tmp() {
			code(str,fun());
		}
		tmp.toString = code.toString.bind(code);
		var fs = fun.toString();
		fs = /^\(\)=>/.test(fs) ? fs.slice(4) : fs;
		it('"'+str+'" ---> '+fs,tmp);
	}
	function it_sr(str,res,code) {
		function tmp() {
			code(str,res);
		}
		tmp.toString = code.toString.bind(code);
		it('"'+str+'" ---> '+JSON.stringify(res),tmp);
	}
	describe('complex tests for one ',()=>{
		it('"ab(xxx|yy|z)cd" -> fun(abcd) -> FatalError',()=>{
			var res = {};
			assert.instanceOf(reg_sequence.exec('ab(xxx|yy|z)cd').fun('abcd',{x:0},res),FatalError);
		})
		it('"ab(xxx|yy|z)cd" -> fun(abzzcd) -> FatalError',()=>{
			var res = {};
			assert.instanceOf(reg_sequence.exec('ab(xxx|yy|z)cd').fun('abzzcd',{x:0},res),FatalError);
		})
		it('"ab(xxx|yy|z)cd" -> fun(abzcd -> abzcd) -> true',()=>{
			var res = {};
			assertDeepEqual(reg_sequence.exec('ab(xxx|yy|z)cd').fun('abzcd',{x:0},res),true);
			assert.strictEqual(res.res,'abzcd');
		})
		it('"ab(xxx|yy|z)cd" -> fun(abyycd -> abyycd) -> true',()=>{
			var res = {};
			assertDeepEqual(reg_sequence.exec('ab(xxx|yy|z)cd').fun('abyycd',{x:0},res),true);
			assert.strictEqual(res.res,'abyycd');
		})
		it('"ab(xxx|yy|z)cd" -> fun(abxxxcd -> abxxxcd) -> true',()=>{
			var res = {};
			assertDeepEqual(reg_sequence.exec('ab(xxx|yy|z)cd').fun('abxxxcd',{x:0},res),true);
			assert.strictEqual(res.res,'abxxxcd');
		})
		it('"ab(xxx)cd" -> fun(abxxxcd -> abxxxcd) -> true',()=>{
			var res = {};
			assertDeepEqual(reg_sequence.exec('ab(xxx)cd').fun('abxxxcd',{x:0},res),true);
			assert.strictEqual(res.res,'abxxxcd');
		})
	})
	describe('reg_sequence ::= "modifier* (symbol quantificator? | `((`modifier*`*`)?alternatives`)` quantificator? )*" ; alternatives ::= "sequence (`|`sequence)*"',()=>{
		describe('script feature',()=>{
			it('"?`{throw {readed:arg}}`<abc" -> fun(abc) -> new ParseError(pos,{readed:"abc"})',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?`{throw {readed:arg}}`<abc').fun('abc',{x:0},res),new ParseError(0,{readed:"abc"}));
			})
			it('"?`{return {readed:arg}}`<abc" -> fun(abc -> {readed:"abc"}) -> true',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?`{return {readed:arg}}`<abc').fun('abc',{x:0},res),true);
				assertDeepEqual(res.res,{readed:"abc"});
			})
			it('"?`arg+arg`?`arg+arg`<abc" -> fun(abc -> abcabcabcabc) -> true',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?`arg+arg`<'+'?`arg+arg`<abc').fun('abc',{x:0},res),true);
				assert.strictEqual(res.res,'abcabcabcabc');
			})
			it('"?`arg+arg`<abc" -> fun(abc -> abcabc) -> true',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?`arg+arg`<abc').fun('abc',{x:0},res),true);
				assert.strictEqual(res.res,'abcabc');
			})
			it('"?{readed:arg}<abc" -> fun(abc -> {readed:"abc"}) -> true',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?{readed:arg}<abc').fun('abc',{x:0},res),true);
				assertDeepEqual(res.res,{readed:"abc"});
			})
		})
		describe('not feature',()=>{
			it('"?!abc" -> fun(ab->"") -> {err:"continue"}',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?!abc').fun('ab',{x:0},res),{err:"continue"});
				assert.strictEqual(res.res,'');
			})
			it('"?!abc" -> fun(abc) -> {err:"break"}',()=>{
				var res = {};
				assertDeepEqual(reg_sequence.exec('?!abc').fun('abc',{x:0},res),{err:"break"});
			})
		})
		it('"abc" -> fun(abc -> abc) -> true',()=>{
			var res = {};
			assertDeepEqual(reg_sequence.exec('abc').fun('abc',{x:0},res),true);
			assert.strictEqual(res.res,'abc');
		})
	})
	describe('modifier ::= "`?` ( `!` | ( \\` ([^\\`])* \\` | `\\`{` ([^\\`])* `}\\`` | object )`<` | identifier`->`)" ; namedModifier ::= "modifier | `?`identifier?`=`"',()=>{
		describe('... match back feature ссылка может быть строкой, {pattern:"паттерн ввиде строки, который снова распарсится и выполнится"}',()=>{
			it_sr('?identifier->',{type:"back_pattern",data:"identifier"},(s,r)=>{
				assertDeepEqual(namedModifier.exec(s),r);
			})
		})
		describe('negate feature',()=>{
			it_sr('?!',{type:"not"},(s,r)=>{
				assertDeepEqual(namedModifier.exec(s),r);
			})
		})
		describe('script feature: object ::= `{`([^\\\'\\"\\{\\}]|string|object)*`}` ; string ::= `"`([^\\"\\\\]|`\\\\\\"`|`\\\\\\\\`)*`"`|`\'`([^\\\'\\\\]|`\\\\\\\'`|`\\\\\\\\`)*`\'`',()=>{
			it_sr('?`"hello world"`error<',{type:"postscript",data:'"hello world"',error:true},(s,r)=>{
				assertDeepEqual(namedModifier.exec(s),r)
			})
			it_sr('?`"hello world"`<',{type:"postscript",data:'"hello world"',error:false},(s,r)=>{
				assertDeepEqual(namedModifier.exec(s),r)
			})
			it_sr('?`{return "hello world"}`<',{type:"postscript",data:'{return "hello world"}',error:false},(s,r)=>{
				assertDeepEqual(namedModifier.exec(s),r)
			})
			describe('complicated object',()=>{
				it_sr('?{x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}<',
					{	type:"postscript",
						data:'{return {x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}}',
						error:false
					},
					(s,r)=>{
					assertDeepEqual(namedModifier.exec(s),r)
				})
				it_sr('?{x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}error<',
					{	type:"postscript",
						data:'{return {x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}}',
						error:true
					},
					(s,r)=>{
						assertDeepEqual(namedModifier.exec(s),r)
				})
				it('object: {x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}} -> "{x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}"',()=>{
					assertDeepEqual(object.exec('{x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}'),'{x1:"hello world",x2:{complicated:"{{{}{}}}}}}{}{}}{"}}')
				})
				it('string: "{{{}{}}}}}}{}{}}{" -> "{{{}{}}}}}}{}{}}{"',()=>{
					assert.strictEqual(string.exec('"{{{}{}}}}}}{}{}}{"'),'"{{{}{}}}}}}{}{}}{"')
				})
			})
		})
		describe('return name feture',()=>{
			it('?identifier= -> {type:"returnname",data:"identifier"}',()=>{
				assertDeepEqual(namedModifier.exec('?identifier='),{type:"returnname",data:'identifier'});
			})
		})
	})
	describe('bnf_quantificator ::= "[`*+?`]|`{`spc*(num|num?spc*`,`spc*num?)spc*`}`" // пока только энергичные',()=>{
		it('{ 3 , 5 } -> {min:3,max:5}',()=>{
			assertDeepEqual(bnf_quantificator.exec('{ 3 , 5 }'),{min:3,max:5})
		})
	})
	describe('reg_quantificator ::= "[`*+?`]|`{`(num|num?`,`num?)`}`" // пока только энергичные',()=>{
		it('+ -> {min:1,max:Infinity}',()=>{
			assertDeepEqual(reg_quantificator.exec('+'),{min:1,max:Infinity})
		})
		it('{3,5} -> {min:3,max:5}',()=>{
			assertDeepEqual(reg_quantificator.exec('{3,5}'),{min:3,max:5})
		})
		it('{3} -> {min:3,max:3}',()=>{
			assertDeepEqual(reg_quantificator.exec('{3}'),{min:3,max:3})
		})
		it('{3,} -> {min:3,max:Infinity}',()=>{
			assertDeepEqual(reg_quantificator.exec('{3,}'),{min:3,max:Infinity})
		})
		it('{,3} -> {min:0,max:3}',()=>{
			assertDeepEqual(reg_quantificator.exec('{,3}'),{min:0,max:3})
		})
	})
	describe('bnf_class ::= `[``^`?spc* (classChar(`-`classChar)?spc* |quotedSequence spc* )*`]`|`.` // возвращает регексп (без галки вначале)',()=>{
		it('[ \\a \\b \\c ] -> /[abc]/',()=>{
			2+2;
			assert.strictEqual(bnf_class.exec('[ \\a \\b \\c ]').source , /[abc]/.source)
		})
	});
	describe('reg_class ::= `[``^`?(classChar(`-`classChar)?|quotedSequence)*`]`|`.` // возвращает регексп (без галки вначале)',()=>{
		it('. -> /./',()=>{
			assert.strictEqual(reg_class.exec('.').source , /./.source)
		})
		it('[] -> /[]/',()=>{
			assert.strictEqual(reg_class.exec('[]').source , /[]/.source)
		})
		it('[^] -> /[^]/',()=>{
			assert.strictEqual(reg_class.exec('[^]').source , /[^]/.source)
		})
		it('[`abc`] -> /[abc]/',()=>{
			assert.strictEqual(reg_class.exec('[`abc`]').source , /[abc]/.source)
		})
		it('[`a^$`] -> /[a\\^\\$]/',()=>{
			assert.strictEqual(reg_class.exec('[`a^$`]').source , /[a\^\$]/.source)
		})
		it('[abc] -> /[abc]/',()=>{
			assert.strictEqual(reg_class.exec('[abc]').source , /[abc]/.source)
		})
		it('[a-z] -> /[a-z]/',()=>{
			assert.strictEqual(reg_class.exec('[a-z]').source , /[a-z]/.source)
		})
		it('[\\$-\\^] -> /[\\$-\\^]/',()=>{
			assert.strictEqual(reg_class.exec('[\\$-\\^]').source , /[\$-\^]/.source)
		})
		it('[a-] -> error',()=>{
			assert.isTrue(isFatal(reg_class.exec('[a-]')))
		})
		it('[a\\-] -> /[a\\-]/',()=>{
			assert.strictEqual(reg_class.exec('[a\\-]').source , /[a\-]/.source)
		})
	})
	describe('bnf_classChar ::= /'+/[^ \\\/` ` ^-|$.*+?()[]{}] | \\./.source+'/ // возвращает символ',()=>{
		it('1 -> 1',()=>{
			assert.strictEqual(bnf_classChar.exec('1'),'1');
		})
		it('" " -> error',()=>{
			assert.instanceOf(bnf_classChar.exec(' '),FatalError);
		})
		it('^ -> error',()=>{
			assert.instanceOf(bnf_classChar.exec('^'),FatalError);
		})
		it('- -> error',()=>{
			assert.instanceOf(bnf_classChar.exec('-'),FatalError);
		})
		it('\\^ -> ^',()=>{
			assert.strictEqual(bnf_classChar.exec('\\^'),'^');
		})
		it('\\- -> -',()=>{
			assert.strictEqual(bnf_classChar.exec('\\-'),'-');
		})
		it('"" -> new FatalError(0,"не могу прочитать bnf_classChar")',()=>{
			assertDeepEqual(bnf_classChar.exec(''),new FatalError(0,'не могу прочитать bnf_classChar'));
		})
	})
	describe('reg_classChar ::= /'+/[^ \\\/` `^-|$.*+?()[]{}] | \\./.source+'/ // возвращает символ',()=>{
		it('1 -> 1',()=>{
			assert.strictEqual(reg_classChar.exec('1'),'1');
		})
		it('" " -> " "',()=>{
			assert.strictEqual(reg_classChar.exec(' '),' ');
		})
		it('^ -> error',()=>{
			assert.instanceOf(reg_classChar.exec('^'),FatalError);
		})
		it('- -> error',()=>{
			assert.instanceOf(reg_classChar.exec('-'),FatalError);
		})
		it('\\^ -> ^',()=>{
			assert.strictEqual(reg_classChar.exec('\\^'),'^');
		})
		it('\\- -> -',()=>{
			assert.strictEqual(reg_classChar.exec('\\-'),'-');
		})
		it('"" -> new FatalError(0,"не могу прочитать reg_classChar")',()=>{
			assertDeepEqual(reg_classChar.exec(''),new FatalError(0,'не могу прочитать reg_classChar'));
		})
	})
	describe('bnf_char ::= /'+/\\./.source+'/ // возвращает символ',()=>{
		it('\\1 -> 1',()=>{
			assert.strictEqual(bnf_char.exec('\\1'),'1');
		})
		it('1 -> error',()=>{
			assert.instanceOf(bnf_char.exec('1'),FatalError);
		})
		it('$ -> error',()=>{
			assert.instanceOf(bnf_char.exec('$'),FatalError);
		})
		it('"" -> new FatalError(0,"не могу прочитать bnf_char")',()=>{
			assertDeepEqual(bnf_char.exec(''),new FatalError(0,'не могу прочитать bnf_char'));
		})
	})
	describe('reg_char ::= /'+/[^ \\\/` `|$.*+?()[]{}] | \\./.source+'/ // возвращает символ',()=>{
		it_sr('1','1',(s,r)=>{
			assert.strictEqual(reg_char.exec(s),r);
		})
		it('$ -> error',()=>{
			assert.instanceOf(reg_char.exec('$'),FatalError);
		})
		it_sr('\\$','$',(s,r)=>{
			assert.strictEqual(reg_char.exec(s),r);
		})
		it_sf("",()=>new FatalError(0,"не могу прочитать reg_char"),(s,r)=>{
			assertDeepEqual(reg_char.exec(s),r);
		})
	})
	describe('quotedSequence ::= /'+/`\`` ( [^`\\] | \\\\ | \\`)* `\``/.source+'/ // возвращает строку',()=>{
		it_sr(/`qwer`/.source,'qwer',(s,r)=>{
			assert.strictEqual(quotedSequence.exec(s),r);
		})
		it_sr(/`qw\\er`/.source,'qw\\er',(s,r)=>{
			assert.strictEqual(quotedSequence.exec(s),r);
		})
		it_sr(/`qw\`er`/.source,'qw`er',(s,r)=>{
			assert.strictEqual(quotedSequence.exec(s),r);
		})
		it_sr(/`qw\\\`er`/.source,'qw\\`er',(s,r)=>{
			assert.strictEqual(quotedSequence.exec(s),r);
		})
		it_sf("",()=>new FatalError(0,"не могу прочитать quotedSequence"),(s,r)=>{
			assertDeepEqual(quotedSequence.exec(s),r);
		})
	})
	describe('meta parser',()=>{
		describe('isGood',function(){
			it('sould be TRUE for: number 0',function(){
				assert.equal(isGood(0),true);
			})
			it('sould be TRUE for: number 2',function(){
				assert.equal(isGood(2),true);
			})
			it('sould be TRUE for: empty string',function(){
				assert.equal(isGood(''),true);
			})
			it('sould be TRUE for: not empty string',function(){
				assert.equal(isGood('123'),true);
			})
			it('sould be TRUE for: {}',function(){
				assert.equal(isGood({}),true);
			})
			it('sould be TRUE for: {err:0}',function(){
				assert.equal(isGood({err:0}),true);
			})
			it('sould be FALSE for: {err:1}',function(){
				assert.equal(isGood({err:1}),false);
			})
			it('sould be FALSE for: {err:2}',function(){
				assert.equal(isGood({err:2}),false);
			})
			it('sould be TRUE for: null',function(){
				assert.equal(isGood(null),true);
			})
			it('sould be FALSE for: undefined',function(){
				assert.equal(isGood(),false);
			})
		})
		describe('notFatal',function(){
			it('sould be TRUE for: number 0',function(){
				assert.equal(isGood(0),true);
			})
			it('sould be TRUE for: number 2',function(){
				assert.equal(isGood(2),true);
			})
			it('sould be TRUE for: empty string',function(){
				assert.equal(isGood(''),true);
			})
			it('sould be TRUE for: not empty string',function(){
				assert.equal(isGood('123'),true);
			})
			it('sould be TRUE for: {}',function(){
				assert.equal(notFatal({}),true);
			})
			it('sould be TRUE for: {err:0}',function(){
				assert.equal(notFatal({err:0}),true);
			})
			it('sould be TRUE for: {err:1}',function(){
				assert.equal(notFatal({err:1}),true);
			})
			it('sould be FALSE for: {err:2}',function(){
				assert.equal(notFatal({err:2}),false);
			})
			it('sould be TRUE for: null',function(){
				assert.equal(isGood(null),true);
			})
			it('sould be FALSE for: undefined',function(){
				assert.equal(notFatal(),false);
			})
		})
	})
	/*
	describe('mocha',()=>{
		it('test assertDeepDiff',()=>{
			var lhs = {
				name: 'my object',
				description: 'it\'s an object!',
				details: {
					it: 'has',
					an: 'array',
					with: ['a', 'few', 'elements']
				}
			};

			var rhs = {
				name: 'updated object',
				description: 'it\'s an object!',
				details: {
					it: 'has',
					an: 'array',
					with: ['a', 'few', 'more', 'elements', { than: 'before' }]
				}
			};
			assertDeepEqual(rhs,lhs);
		})
		it('test throw',()=>{
			function foo(nest) {
				if(nest===20)
					throw new Error('some\nmulti\nline\nstring\nvery\nv\ne\nr\ny\nm\nu\nl\nt\ny\nline')
				else
					foo(nest+1);
			}
			foo(0)
		})
	});
	*/
		mocha.run();
})()
	</script>
</body>
</html>