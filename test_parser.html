<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8"/>
  <title>test-parser</title>

  <script src="jquery-2.2.0.js"></script>

  <link href="mocha.css" rel="stylesheet" />.
  <script src="deepDiff.js"></script>
  <script src="mocha.js"></script>
  <script src="chai.js"></script>
  <script>
	//mocha.checkLeaks();
    //mocha.globals(['jQuery']);
    mocha.setup('bdd');
    var assert = chai.assert;
  </script>

  <script src="utils.js"></script>
  <script src="modules_manager.js"></script>
  
  <script src="parser_test_utils.js"> </script>
  
  <script src="meta_parser.js"> </script>
  <script src="parser.js"> </script>

  </head>
<body>
	<p>
	В паттерне перед ---&gt; строка в кавычках как есть. А после - JSON.stringify() или fun(...).
	<br>
	В строке для разбора - сначала строка как есть без кавычек, а потом, после ---&gt; - JSON.stringify().
	</p>
	<div id="mocha"/>
<script>
;(function(){
	'use strict';
	copyProps(require('parser'),window);
	copyProps(require('parser_test_utils'),window);

// ===============================================================================
	_describe('complex tests for one pattern',()=>{
		describe('objects',()=>{
			it_parse('?=a(?=bc)d'		,'abcd','bc','reg_sequence')
			it_parse('a(?y=bc)d'	,'abcd',{y:"bc"},parse('reg_sequence'));
			it_parse('?x=a(?y=bc)d'	,'abcd',{x:{y:"bc"}},parse('reg_sequence'))
			it_parse('?x=abcd'		,'abcd',{x:"abcd"},parse('reg_sequence'))
			it_parse('?=abcd'		,'abcd','abcd',parse('reg_sequence'))
		})
		describe('cycle',()=>{
			it_parse('ab(xx)*cd','abxxxxcd','abxxxxcd',parse('reg_sequence'))
		})
		describe('alternatives',()=>{
			it_err_parse('ab(xxx|yy|z)cd'	,'abcd'		,()=>err_filtered(2,[
				err_rgx(2,'xxx'),err_rgx(2,'yy'),err_rgx(2,'z'),]))
			it_err_parse('ab(xxx|yy|z)cd'	,'abzzcd'	,()=>err_rgx(3,'cd'))
			it_parse(	'ab(xxx|yy|z)cd'	,'abzcd'	,'abzcd',parse('reg_sequence'))
			it_parse(	'ab(xxx|yy|z)cd'	,'abyycd'	,'abyycd',parse('reg_sequence'))
			it_parse(	'ab(xxx|yy|z)cd'	,'abxxxcd'	,'abxxxcd',parse('reg_sequence'))
		})
		describe('stringify',()=>{
			it_parse('ab(?`"zzz"`<xxx)cd','abxxxcd','abzzzcd',parse('reg_sequence'))
			it_parse('ab(?`zzz`<xxx)cd'	,'abxxxcd','abcd','reg_sequence','за то накапливает ошибки') // # todo err
			it_parse("ab(?{x:3}<xxx)cd"	,'abxxxcd','ab{"x":3}cd',parse('reg_sequence'))
		})
		it_parse("ab(xxx)cd",'abxxxcd','abxxxcd',parse('reg_sequence'))
	})
	_describe('reg_sequence ::= "modifier* (symbol quantificator? | `((`modifier*`*`)?alternatives`)` quantificator? )*" ; alternatives ::= "sequence (`|`sequence)*"',()=>{
		describe('script feature',()=>{
			it_parse(	'?`{throw {readed:arg}}`<abc'	,'abc',undefined,parse(reg_sequence),'за то в набор складывает') // #todo err
			it_parse(	'?`{return {readed:arg}}`<abc'	,'abc',{readed:"abc"},parse(reg_sequence))
			it_parse(	"?`arg+arg`<'+'?`arg+arg`<abc"		,'abc','abcabcabcabc',parse(reg_sequence))
			it_err_compile(	"?`arg+arg`<'+'?`arg+arg`abc"	,()=>err_filtered(21,[
					err_txt(21,'error'),
					err_txt(21,'<'),
					err_txt(21,'?<'),
					err_id(12),
					err_txt(12,'!'),
					err_id(12),
					err_txt(12,'='),
					err_txt(12,'toString:'),
					err_char(11),
					err_txt(11,'('),
					err_txt(11,'$')
				]),compile(reg_sequence))
			it_err_compile(	"?`arg+arg`?`arg+arg`<abc"	,()=>err_filtered(10,[
					err_txt(10,'error'),
					err_txt(10,'<'),
					err_txt(10,'?<'),
					err_id(1),
					err_txt(1,'!'),
					err_id(1),
					err_txt(1,'='),
					err_txt(1,'toString:'),
					err_char(0),
					err_txt(0,'('),
					err_txt(0,'(?#')
				]),'reg_sequence')
			it_parse(	"?`arg+arg`<abc"				,'abc','abcabc',parse(reg_sequence))
			it_parse(	"?{readed:arg}<abc"				,'abc',{readed:"abc"},parse(reg_sequence))
		})
		describe('not feature',()=>{
			it('"?!abc" -> fun(ab->"") -> {err:"continue"}',()=>{ // parse and err_parse
				var res = {};
				assertDeepEqual(reg_sequence.exec('?!abc').fun('ab',{x:0},res),{err:"continue"});
				assert.strictEqual(res.res,'');
			})
			it_err_parse('?!abc','abc',()=>(err_fail_not(0,'безымянная последовательность')),parse(reg_sequence))
		})
		it_parse("abc",'abc','abc',parse(reg_sequence));
	})
	run_tests();
	/*
	describe('mocha',()=>{
		it('test assertDeepDiff',()=>{
			var lhs = {
				name: 'my object',
				description: 'it\'s an object!',
				details: {
					it: 'has',
					an: 'array',
					with: ['a', 'few', 'elements']
				}
			};

			var rhs = {
				name: 'updated object',
				description: 'it\'s an object!',
				details: {
					it: 'has',
					an: 'array',
					with: ['a', 'few', 'more', 'elements', { than: 'before' }]
				}
			};
			assertDeepEqual(rhs,lhs);
		})
		it('test throw',()=>{
			function foo(nest) {
				if(nest===20)
					throw new Error('some\nmulti\nline\nstring\nvery\nv\ne\nr\ny\nm\nu\nl\nt\ny\nline')
				else
					foo(nest+1);
			}
			foo(0)
		})
	});
	*/
	mocha.run();
})()
	</script>
</body>
</html>